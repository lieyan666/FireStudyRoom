<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>自习室待办事项</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .todo-container {
      margin-top: 20px;
    }
    .todo-item {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .completed {
      text-decoration: line-through;
      opacity: 0.7;
    }
    .todo-form {
      margin-bottom: 20px;
    }
    .todo-form input {
      padding: 8px;
      margin-right: 10px;
      width: 300px;
    }
  </style>
</head>
<body>
  <h1>自习室待办事项</h1>
  <div class="todo-form">
    <input type="text" id="new-todo" placeholder="输入新的待办事项">
    <button onclick="addTodo()">添加</button>
  </div>
  <div class="todo-container" id="todo-list"></div>

  <script>
    // 获取JWT token
    function getToken() {
      const cookie = document.cookie
        .split('; ')
        .find(row => row.startsWith('token='));
      return cookie ? cookie.split('=')[1] : null;
    }

    // 检查token有效性
    function checkAuth() {
      const token = getToken();
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }
      return true;
    }

    // 初始化WebSocket连接
    function initWebSocket() {
      const token = getToken();
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const ws = new WebSocket(`ws://${window.location.host}`, `Bearer-${token}`);

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        // 假设错误消息包含 '401' 表示认证失败
        // if (error.message.includes('401')) {
        //   window.location.href = '/login.html';
        // }
      };

      ws.onclose = (event) => {
        console.log('WebSocket connection closed with code:', event.code);
        if (event.code === 1008) {
          // 服务器端关闭代码 1008 表示策略违规，可能是认证失败
          window.location.href = '/login.html';
        }
      };

      return ws;
    }

    // 检查认证状态
    // if (!checkAuth()) {
    //   throw new Error('Unauthorized');
    // }

    const ws = initWebSocket();
    let todos = [];

    // WebSocket消息处理
    ws.onmessage = (event) => {
      const { type, data } = JSON.parse(event.data);
      
      switch (type) {
        case 'INIT':
          todos = data;
          renderTodos();
          break;
        case 'ADD_TODO':
        case 'UPDATE_TODO':
        case 'DELETE_TODO':
          todos = data;
          renderTodos();
          break;
      }
    };

    // WebSocket消息处理
    ws.onmessage = (event) => {
      const { type, data } = JSON.parse(event.data);
      
      switch (type) {
        case 'INIT':
          todos = data;
          renderTodos();
          break;
        case 'ADD_TODO':
        case 'UPDATE_TODO':
        case 'DELETE_TODO':
          todos = data;
          renderTodos();
          break;
      }
    };

    // 渲染待办事项
    function renderTodos() {
      const container = document.getElementById('todo-list');
      container.innerHTML = todos.map(todo => `
        <div class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
          <span>${todo.text}</span>
          <div>
            <button onclick="toggleComplete('${todo.id}')">
              ${todo.completed ? '未完成' : '完成'}
            </button>
            <button onclick="deleteTodo('${todo.id}')">删除</button>
          </div>
        </div>
      `).join('');
    }

    // 添加待办事项
    function addTodo() {
      const input = document.getElementById('new-todo');
      const text = input.value.trim();
      if (!text) return;

      const newTodo = {
        id: Date.now().toString(),
        text,
        completed: false,
        createdAt: new Date().toISOString(),
        createdBy: '当前用户', // TODO: 从登录系统获取
        completedAt: null
      };

      todos.push(newTodo);
      ws.send(JSON.stringify({
        type: 'ADD_TODO',
        data: todos
      }));

      input.value = '';
    }

    // 切换完成状态
    function toggleComplete(id) {
      todos = todos.map(todo => {
        if (todo.id === id) {
          return {
            ...todo,
            completed: !todo.completed,
            completedAt: todo.completed ? null : new Date().toISOString()
          };
        }
        return todo;
      });

      ws.send(JSON.stringify({
        type: 'UPDATE_TODO',
        data: todos
      }));
    }

    // 删除待办事项
    function deleteTodo(id) {
      todos = todos.filter(todo => todo.id !== id);
      ws.send(JSON.stringify({
        type: 'DELETE_TODO',
        data: todos
      }));
    }
  </script>
</body>
</html>
